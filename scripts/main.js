(()=>{var B=Object.defineProperty;var a=(e,n)=>B(e,"name",{value:n,configurable:!0});var p="pf2e-spells-summary";function b(e){return`modules/${p}/templates/${e}.hbs`}a(b,"templatePath");function x(e){return game.settings.get(p,e)}a(x,"getSetting");function D(e,n){return e.localeCompare(n,game.i18n.lang)}a(D,"localeCompare");async function F(e){let n=e.system.resources.focus??{value:0,max:0},s=game.modules.get("pf2e-staves")?.active,t=[],i=[],o=!1;if(await Promise.all(e.spellcasting.regular.map(async l=>{let c=l.id,u=l.statistic.dc.value,L=l.name,r=await l.getSheetData(),h=r.isFocusPool,f=l.system?.prepared?.value==="charge",k=getProperty(l,"flags.pf2e-staves.staveID")!==void 0,O={value:getProperty(l,"flags.pf2e-staves.charges")??0};for(let d of r.levels){if(!d.active.length||d.uses?.max===0)continue;let P=[],S=d.isCantrip,C=d.active.filter(v=>v&&v.uses?.max!==0),T=!S&&f&&!s;for(let v=0;v<C.length;v++){let{spell:y,expended:w,virtual:U,uses:M,castLevel:_}=C[v];P.push({name:y.name,img:y.img,range:y.system.range.value||"-",castLevel:_??y.level,slotId:v,entryId:c,entryDc:u,entryName:L,itemId:y.id,inputId:r.isInnate?y.id:r.id,inputPath:f?"flags.pf2e-staves.charges":r.isInnate?"system.location.uses.value":`system.slots.slot${d.level}.value`,isCharge:f,isActiveCharge:f&&s,isBroken:T,isVirtual:U,isInnate:r.isInnate,isCantrip:S,isFocus:h,isPrepared:r.isPrepared,isSpontaneous:r.isSpontaneous||r.isFlexible,slotLevel:d.level,uses:M??(f?O:d.uses),expended:w??(h&&!S?n.value<=0:!1),action:y.system.time.value,type:f?k?`${p}.staff`:`${p}.charges`:r.isInnate?"PF2E.PreparationTypeInnate":r.isSpontaneous?"PF2E.PreparationTypeSpontaneous":r.isFlexible?"PF2E.SpellFlexibleLabel":h?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:f?0:r.isPrepared?1:h?2:r.isInnate?3:r.isSpontaneous?4:5,noHover:r.isPrepared||S||T||h})}if(P.length){if(h)if(S)o=!0;else{i.push(...P);continue}t[d.level]??=[],t[d.level].push(...P)}}})),t.length){let l=x("order")?(c,u)=>c.order===u.order?D(c.name,u.name):c.order-u.order:(c,u)=>D(c.name,u.name);t.forEach(c=>c.sort(l))}i.length&&(i.sort((l,c)=>D(l.name,c.name)),t[12]=i,o=!1);let m=(await e.spellcasting.ritual?.getSheetData())?.levels.flatMap((l,c)=>l.active.map(({spell:u})=>({name:u.name,img:u.img,slotId:c,itemId:u.id,level:u.level,time:u.system.time.value})).filter(Boolean));return{spells:t,rituals:m,focusPool:n,stavesActive:s,hasFocusCantrips:o,isOwner:e.isOwner}}a(F,"getData");async function E(e,n){let s=e.actor;if(!s||s.pack||!s.id||!s.isOfType("character"))return;let t=I(n);getProperty(e,`modules.${p}.toggled`)&&t.addClass("toggled"),X(n).on("click",i=>W(i,n,e)),await A(n,e,s),t.hasClass("toggled")&&t.hasClass("active")&&e._restoreScrollPositions(n)}a(E,"renderCharacterSheetPF2e");async function A(e,n,s){let t=I(e),i=await F(s),o=await renderTemplate(b("sheet"),i);t.append(o),H(e,n,s)}a(A,"addSummaryTab");function H(e,n,s){let t=Z(e),i=t.find(".spell-type .uses .spell-slots-input input");i.on("change",o=>N(o,s)),i.on("focus",R),i.on("blur",j),t.find(".cast-spell").on("click",o=>J(o,s)),t.find(".item-toggle-prepare").on("click",o=>V(o,s)),t.find(".focus-pips").on("click contextmenu",o=>q(o,s)),t.find(".spell-slots-increment-reset").on("click",o=>G(o,n,s)),t.find(".item-image").on("click",o=>Q(o,s)),t.find(".item-name > h4").on("click",o=>K(o,n))}a(H,"addSummaryEvents");async function N(e,n){e.preventDefault();let{inputPath:s,entryId:t}=$(e.currentTarget).data(),i=e.currentTarget.valueAsNumber;n.updateEmbeddedDocuments("Item",[{_id:t,[s]:i}])}a(N,"onUsesInputChange");function R(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.add("hover")}a(R,"onUsesInputFocus");function j(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.remove("hover")}a(j,"onUsesInputBlur");function V(e,n){e.preventDefault();let{slotLevel:s,slotId:t,entryId:i,expended:o}=$(e.currentTarget).closest(".item").data();n.spellcasting.collections.get(i)?.setSlotExpendedState(s??0,t??0,o!==!0)}a(V,"onTogglePrepare");function q(e,n){e.preventDefault();let s=e.type==="click"?1:-1,t=(n.system.resources.focus?.value??0)+s;n.update({"system.resources.focus.value":t})}a(q,"onToggleFocusPool");function z(e,n){Y(e.element).find(`.item-container.spellcasting-entry[data-item-id=${n}]`).find(".spell-ability-data .statistic-values a.pf2e-staves-charge")[0]?.click()}a(z,"onChargeReset");function G(e,n,s){e.preventDefault();let{itemId:t,level:i,isCharge:o}=$(e.currentTarget).data();if(!t)return;if(o){z(n,t);return}let g=s.items.get(t);if(g){if(g.isOfType("spellcastingEntry")){let m=i>=0&&i<=11?`slot${i}`:"slot0",l=g.system.slots?.[m];l&&g.update({[`system.slots.${m}.value`]:l.max})}else if(g.isOfType("spell")){let m=g.system.location.uses?.max;m&&g.update({"system.location.uses.value":m})}}}a(G,"onSlotsReset");function J(e,n){e.preventDefault();let s=$(e.currentTarget);if(s.prop("disabled"))return;let{itemId:t,slotLevel:i,slotId:o,entryId:g}=s.closest(".item").data(),m=n.spellcasting.collections.get(g);if(!m)return;let l=m.get(t);l&&m.entry.cast(l,{slot:o,level:i})}a(J,"onCastSpell");async function K(e,n){let s=e.currentTarget.closest(".item");await n.itemRenderer.toggleSummary(s)}a(K,"onToggleSummary");async function Q(e,n){let s=$(e.currentTarget).closest(".item").attr("data-item-id"),t=n.items.get(s);!t||t.isOfType("physical")&&!t.isIdentified||await t.toMessage(e)}a(Q,"onItemToChat");function W(e,n,s){e.preventDefault();let t=I(n);t.hasClass("active")&&(t.toggleClass("toggled"),t.scrollTop(0),setProperty(s,`modules.${p}.toggled`,t.hasClass("toggled")))}a(W,"onSpellcastingBtnToggle");function X(e){return e.find("nav.sheet-navigation .item[data-tab=spellcasting]")}a(X,"getSpellcastingNav");function I(e){return e.find("section.sheet-body .sheet-content > .tab[data-tab=spellcasting]")}a(I,"getSpellcastingTab");function Y(e){return I(e).find(".directory-list.spellcastingEntry-list")}a(Y,"getSpellcastingOriginalSection");function Z(e){return I(e).find(".directory-list.summary")}a(Z,"getSpellcastingSummarySection");Hooks.on("renderCharacterSheetPF2e",E);Hooks.once("ready",()=>{game.settings.register(p,"order",{name:`${p}.settings.order.name`,hint:`${p}.settings.order.hint`,type:Boolean,default:!1,config:!0,scope:"client",onChange:ee})});function ee(){Object.values(ui.windows).forEach(e=>e instanceof ActorSheet&&e.actor.type==="character"&&e.render())}a(ee,"refreshSheets");})();
//# sourceMappingURL=main.js.map
